<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Weighted Tree</title>

    <link href='https://fonts.googleapis.com/css?family=Roboto|Raleway:600,400,200' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="lib/styles/vizuly.css">

    <script src="lib/d3_v5.7.min.js"></script>

    <script src="lib/vizuly2_core.min.js"></script>
    <script src="src/WeightedTree.js"></script>
    
	<script src="data/iucn.js"></script>

</head>

<body>

<button onclick="viz.update(true)">Expand all</button>

<!-- Our main content container-->
<div class="container" style="width:100% ">
    <div id="viz_container" class="z-depth-3" style="width:900px; height:900px;">
    </div>
</div>
<div style="position:absolute; bottom:10px; left:10px; font-size:10px; color:#777"><span>v.</span> 2.1.220 - @date</div>

<script>

var oceanStyles = {
	'background-color-top': '#021F51',
	'background-color-bottom': '#039FDB',
	'label-color': '#FFF',
	'label-fill-opacity': 1,
	'link-stroke': function (d, i) {
		//return '#FFF'
		var colors = ["#FFA000", "#FF5722", "#F57C00", "#FF9800", "#FFEB3B"];
		if (d.target.data.Category) {
			if (d.target.data.Category == "Threatened") {
				//console.log(d);
				return '#FF0000';
			}
		}
		//return '#FFF0000';
		return colors[d.target.rootIndex % colors.length];
	},
	'link-stroke-opacity': .4,
	'node-stroke':  '#FFF',
	'node-stroke-opacity': 1,
	'node-fill': function (d, i) {
		//return '#FFF'
		var colors = ["#C50A0A", "#C2185B", "#F57C00", "#FF9800", "#FFEB3B"];
		if (d.data.Category) {
			if (d.data.Category == "Threatened") {
			//
			return '#FF0000';
			}
		}
//		return '#FFF'; // solid color
		return colors[d.rootIndex % colors.length];
	},
	'node-fill-opacity': .7
}


// original .html
	// Our visualization component.
	var viz = vizuly2.viz.WeightedTree("#viz_container");
	var display = "evaluated";
	viz.data({key: 'Species', values: data})
	 .width('100%')
	 .height('100%')
	 .children(function (d) { return d.values })
	 .key(function (d) { return d.key || d.Category; })
	 .value(function (d) {
		 var ret = Number(d.TotalEvaluated || d.Total)
		 if (isNaN(ret)) {
		 	if (d.children) { 
			 if (display == "evaluated") {
			 	console.log("eval");
			 	return d.children[1].Total * 10; 
			 } else {
			 	console.log("estim");
				return d.children[0].Total * 10;
			 }
			 // use TotalEstimated from child
		 	}
		 }
		 //return Number(5000);
		 return isNaN(ret) ? 0 : ret;
	 })
	 .valueFormatter(formatValue)
	 .label(function (d) { 
		var num = Number(d.TotalEvaluated || d.Total)
		 if (isNaN(num)) {
		 	if (d.children) { 
			 if (display == "evaluated") {
			 	console.log("eval");
			 	var num = d.children[1].Total; 
			 } else {
			 	console.log("estim");
				var num = d.children[0].Total;
			 }
			 // use TotalEstimated from child
		 	}
		 }
	 	return trimLabel(d.key || (d.Category)) + " (" + num + ")"})
	 .dataTipLabel(function (d) { return d.key || d.Category })
	 .useZoomToNode(true)
	 .useZoom(true)
	 .on("mouseover", onMouseOver)
	 .on("mouseout", onMouseOut)
	 .on("click", onClick)
	
	viz.update();
	changeStyles('oceanStyles');

	// format sums
	function formatValue (d) {
		if (isNaN(d)) d = 0;
		return d3.format("d")(d) + " Species";
	};

	// trim node labels
	function trimLabel(label) {
		return (String(label).length > 20) ? String(label).substr(0, 17) + "..." : label;
	}

	function onMouseOver(e, d, i) {
		console.log("onMouseOver " + display);
	}

	function onMouseOut(e, d, i) {
		console.log("onMouseOut " + d.data.Category)
	}

	//We can capture click events and respond to them
	function onClick(g, d, i) {
		console.log('onClick ' + d.data.Category)
	}

function changeStyles(val) {
	var styles = this[val];
	viz.clearStyles();
	viz.applyStyles(styles);
	viz.update();
}
</script>
</body>
</html>
